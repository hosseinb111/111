// --- Appwrite User Session Check ---
        async function checkUserSessionAppwrite() {
            console.log("Checking Appwrite user session...");
            if (!appwriteAccount || !appwriteDatabases) {
                console.error("Appwrite services not available for session check. Redirecting to login page.");
                if(welcomeMessageEl) welcomeMessageEl.textContent = "Appwrite connection error. Redirecting...";
                // MODIFIED: Redirect to index.html
                window.location.href = window.location.origin + '/index.html'; 
                return;
            }
            try {
                currentUserAppwrite = await appwriteAccount.get();
                console.log("Appwrite user session found:", currentUserAppwrite);
                
                try {
                    currentUserProfileAppwrite = await appwriteDatabases.getDocument(
                        USER_DATABASE_ID_APPWRITE,
                        USER_PROFILE_COLLECTION_ID_APPWRITE,
                        currentUserAppwrite.$id
                    );
                    console.log("Appwrite user profile found:", currentUserProfileAppwrite);

                    if (!currentUserProfileAppwrite.username) {
                        console.error("Appwrite user profile does not contain a username. Redirecting to login page.");
                        if(welcomeMessageEl) welcomeMessageEl.textContent = `Profile error for ${currentUserAppwrite.name}. Redirecting...`;
                        // MODIFIED: Redirect to index.html with error parameter
                        window.location.href = window.location.origin + '/index.html?error=profile_incomplete';
                        return;
                    }

                    if (welcomeMessageEl) welcomeMessageEl.textContent = `Logged in as: ${currentUserProfileAppwrite.username}`;
                    
                    messageInput.disabled = false;
                    sendButton.disabled = false; // Assuming sendButton is your actual send button ID
                    
                    if (firebaseDb) {
                        loadInitialMessagesFirebase();
                        subscribeToMessagesFirebase();
                    } else {
                        console.error("Firebase DB not initialized. Cannot load messages.");
                        if(loadingMessagesEl) loadingMessagesEl.textContent = 'Chat message system not available.';
                    }

                } catch (profileError) {
                    console.error("Failed to fetch Appwrite user profile:", profileError);
                    if(welcomeMessageEl) welcomeMessageEl.textContent = `Error fetching profile for ${currentUserAppwrite.name}. Redirecting...`;
                    // MODIFIED: Redirect to index.html with error parameter
                    window.location.href = window.location.origin + '/index.html?error=profile_missing';
                    return;
                }
                
            } catch (sessionError) {
                console.log("Appwrite: No active user session found. Redirecting to login page.", sessionError);
                if(welcomeMessageEl) welcomeMessageEl.textContent = "Not logged in. Redirecting...";
                // MODIFIED: Redirect to index.html
                window.location.href = window.location.origin + '/index.html'; 
            }
        }
